<!DOCTYPE html>
<html>
<head>
    <meta name="google-signin-client_id" content="554516618793-ifeit253j8af1tk01nllnjg59lrrl5cu.apps.googleusercontent.com">
    <link rel="stylesheet" type="text/css" href="Login.css">
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="Login.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    
    <title>Park My Car - Login</title>
    <style>
    .w3-bar .w3-button {
        padding: 16px;
    }
</style>
</head>

<body>

    <!-- Navbar (sit on top) -->
    <div class="w3-top">
        <div class="w3-bar w3-white w3-card" id="myNavbar">
            <a href="index.html" class="w3-bar-item w3-button w3-wide">PARK MY CAR</a>
            <!-- Right-sided navbar links -->
            <div class="w3-right w3-hide-small">
            </div>
            <!-- Hide right-floated links on small screens and replace them with a menu icon -->

            <a href="javascript:void(0)" class="w3-bar-item w3-button w3-right w3-hide-large w3-hide-medium" onclick="w3_open()">
                <i class="fa fa-bars"></i>
            </a>
        </div>
    </div>

    <!-- Sidebar on small screens when clicking the menu icon -->
    <nav class="w3-sidebar w3-bar-block w3-black w3-card w3-animate-left w3-hide-medium w3-hide-large" style="display:none" id="mySidebar">
        <a href="javascript:void(0)" onclick="w3_close()" class="w3-bar-item w3-button w3-large w3-padding-16">Close Ã—</a>
    </nav>
    
    <!-- Register/Login forms-->
    <div class="login-page">
        <div class="form">
            <form id="register-form" class="register-form">
                <input id="firstname" type="text" placeholder="first name"/>
                <span id="firstname_validation" class="error"></span>
                <input id="lastname" type="text" placeholder="last name"/>
                <span id="lastname_validation" class="error"></span>
                <input id="username_register" type="email" placeholder="email address"/>
                <span id="email_validation" class="error"></span>
                <input id="password_register" type="password" placeholder="password"/>
                <span id="password_validation" class="error"></span>
                <button onclick="return register()">create</button>
                <span id="register_form_validation" class="error"></span>
                <p class="message">Already registered? <a href="#">Sign In</a></p>
            </form>
            <form id ="login-form" class="login-form">
                <input id="username_login" type="email" placeholder="username"/>
                <span id="email_login_validation" class="error"></span>
                <input id="password_login" type="password" placeholder="password"/>
                <span id="password_login_validation" class="error"></span>
                <button onclick="return login()">login</button>
                <span id="login_form_validation" class="error"></span>
                <p class="message">Not registered? <a href="#">Create an account</a></p>

                <div class="g-signin2" data-onsuccess="onSignIn"></div>
            </form>
            
        </div>
    </div>
    <script>
        

        function validateRegisterForm(){  
            var valid = 1;
            var firstname = document.getElementById('firstname');
            var lastname = document.getElementById('lastname');
            var email = document.getElementById('username_register');
            var password = document.getElementById('password_register');
            var username_filter = /^[a-zA-Z]*$/;
            var regex =  /^\d{10}$/;
            var filter = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            var firstname_validation = document.getElementById('firstname_validation');
            var lastname_validation = document.getElementById('lastname_validation');
            var email_validation = document.getElementById("email_validation");
            var password_validation = document.getElementById("password_validation");


            if (firstname.value === "") {
                valid = 0;
                firstname_validation.innerHTML = "Field Required";
                firstname_validation.style.display = "block";
                firstname_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else if (!username_filter.test(firstname.value)) {
                first_name_valid = 0;
                firstname_validation.innerHTML = "Invalid First Name";
                firstname_validation.style.display = "block";
                firstname_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else {
                firstname_validation.style.display = "none";
                firstname_validation.parentNode.style.backgroundColor = "transparent";
            }

            if (lastname.value === "") {
                valid = 0;
                lastname_validation.innerHTML = "Field Required";
                lastname_validation.style.display = "block";
                lastname_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else  if (!username_filter.test(valid.value)) {
                valid = 0;
                lastname_validation.innerHTML = "Invalid Last Name";
                lastname_validation.style.display = "block";
                lastname_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else {
                lastname_validation.style.display = "none";
                lastname_validation.parentNode.style.backgroundColor = "transparent";
            }

            if (email.value === "") {
                valid = 0;
                email_validation.innerHTML = "Field Required";
                email_validation.style.display = "block";
                email_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else if(!filter.test(email.value)){
                valid = 0;
                email_validation.innerHTML = "Invalid Email Address";
                email_validation.style.display = "block";
                email_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else {
                email_validation.style.display = "none";
                email_validation.parentNode.style.backgroundColor = "transparent";
            }


            if (password.value === "") {
                valid = 0;
                password_validation.innerHTML = "Field Required";
                password_validation.style.display = "block";
                password_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else if (password.length <6) {
                valid = 0;
                password_validation.innerHTML = "Password should be atleast 6 characters long";
                password_validation.style.display = "block";
                password_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else {
                password_validation.style.display = "none";
                password_validation.parentNode.style.backgroundColor = "transparent";
            }

            if (!valid){
                return false;
            }
            return true;

            
        }

        function register() {
            if(validateRegisterForm()){
                var api_url = 'http://149.165.171.50:30008/api/register?firstname='+document.getElementById("firstname").value+'&lastname='+document.getElementById("lastname").value+'&username='+document.getElementById("username_register").value+'&password='+document.getElementById("password_register").value;
                $.ajax({
                    type:'get',
                    dataType:'json',
                    url: api_url,
                    success: function(user) {
                        window.sessionStorage.setItem("user",user.userId);
                        window.location.href = "dashboard/dashboard.html";
                    },
                    error: function (textStatus, errorThrown) {
                        var register_form_validation = document.getElementById("register_form_validation");
                        register_form_validation.innerHTML = "Register Error";
                        register_form_validation.style.display = "block";
                        register_form_validation.parentNode.style.backgroundColor = "#FFDFDF";
                        console.log(textStatus);
                        console.log(errorThrown);
                    }
                });
                // prevent further bubbling of event
            }
            return false; 
        }

        function validateLoginForm(){

            var valid = 1;
            var email = document.getElementById('username_login');
            var password = document.getElementById('password_login');
            var filter = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            var email_validation = document.getElementById("email_login_validation");
            var password_validation = document.getElementById("password_login_validation");

            if (email.value === "") {
                valid = 0;
                email_validation.innerHTML = "Field Required";
                email_validation.style.display = "block";
                email_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else if(!filter.test(email.value)){
                valid = 0;
                email_validation.innerHTML = "Invalid Email Address";
                email_validation.style.display = "block";
                email_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else {
                email_validation.style.display = "none";
                email_validation.parentNode.style.backgroundColor = "transparent";
            }


            if (password.value === "") {
                valid = 0;
                password_validation.innerHTML = "Field Required";
                password_validation.style.display = "block";
                password_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else if (password.length <6) {
                valid = 0;
                password_validation.innerHTML = "Password should be atleast 6 characters long";
                password_validation.style.display = "block";
                password_validation.parentNode.style.backgroundColor = "#FFDFDF";
            } else {
                password_validation.style.display = "none";
                password_validation.parentNode.style.backgroundColor = "transparent";
            }

            if (!valid){
                return false;
            }
            return true;

            
        
        }

        function login() {
            if(validateLoginForm()){
                var api_url = 'http://149.165.171.50:30008/api/login?username='+document.getElementById("username_login").value+'&password='+document.getElementById("password_login").value;
                $.ajax({
                    type:'get',
                    dataType:'json',
                    url: api_url,
                    success: function(user) {
                        console.log(user);
                        window.sessionStorage.setItem("user",user.userId);
                        window.location.href = "dashboard/dashboard.html";
                    },
                    error: function (textStatus, errorThrown) {
                        var login_form_validation = document.getElementById("login_form_validation");
                        login_form_validation.innerHTML = "Login Error";
                        login_form_validation.style.display = "block";
                        login_form_validation.parentNode.style.backgroundColor = "#FFDFDF";
                        console.log(textStatus);
                        console.log(errorThrown);
                    }
                });
                // prevent further bubbling of event
            }
            return false;
        }

        function onSignIn(googleUser) {
            var profile = googleUser.getBasicProfile();
            console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
            console.log('Name: ' + profile.getName());
            console.log('Image URL: ' + profile.getImageUrl());
            console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.
            console.log('Given Name: ' + profile.getGivenName());
            console.log('Family Name: ' + profile.getFamilyName());
            var username = profile.getEmail();
            var firstname = profile.getGivenName();
            var lastname = profile.getFamilyName();


            var api_url = 'http://149.165.171.50:30008/api/googlelogin?username='+username+'&firstname='+firstname+'&lastname='+lastname;
                $.ajax({
                    type:'get',
                    dataType:'json',
                    url: api_url,
                    success: function(user) {
                        console.log(user);
                        window.sessionStorage.setItem("user",user.userId);
                        window.location.href = "dashboard/dashboard.html";
                    },
                    error: function (textStatus, errorThrown) {
                        var login_form_validation = document.getElementById("login_form_validation");
                        login_form_validation.innerHTML = "Login Error";
                        login_form_validation.style.display = "block";
                        login_form_validation.parentNode.style.backgroundColor = "#FFDFDF";
                        console.log(textStatus);
                        console.log(errorThrown);
                    }
                });
        }
    </script>
</body>
</html>